<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDWAN Surveillance Dashboard - Nextgen Center</title>

    <!-- Auth Check -->
    <script>
        if (localStorage.getItem('nextgenAuth') !== 'authenticated') {
            window.location.href = '../login.html';
        }
    </script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --text-muted: #606070;
            --border-color: rgba(255, 255, 255, 0.08);
            --accent-1: #6366f1;
            --accent-2: #8b5cf6;
            --accent-3: #a855f7;
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            --glow-1: rgba(99, 102, 241, 0.4);
            --critical: #ef4444;
            --major: #f59e0b;
            --minor: #10b981;
            --cleared: #06b6d4;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #f1f5f9;
            --bg-card: rgba(0, 0, 0, 0.02);
            --bg-card-hover: rgba(0, 0, 0, 0.05);
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #94a3b8;
            --border-color: rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        /* Header */
        .header {
            position: sticky;
            top: 0;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            z-index: 100;
            padding: 16px 24px;
        }

        [data-theme="light"] .header {
            background: rgba(255, 255, 255, 0.95);
        }

        .header-content {
            max-width: 1600px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: var(--accent-1);
            border-color: var(--accent-1);
            color: white;
        }

        .back-btn svg {
            width: 16px;
            height: 16px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 36px;
            height: 36px;
            background: var(--gradient-1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 20px;
            height: 20px;
            color: white;
        }

        .logo-text {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .last-update {
            font-size: 0.8rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .last-update svg {
            width: 14px;
            height: 14px;
        }

        .refresh-btn,
        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        .refresh-btn:hover,
        .theme-toggle:hover {
            background: var(--bg-card-hover);
            transform: rotate(15deg);
        }

        .refresh-btn svg,
        .theme-toggle svg {
            width: 18px;
            height: 18px;
        }

        .refresh-btn.loading svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .theme-toggle .sun-icon {
            display: none;
        }

        [data-theme="light"] .theme-toggle .moon-icon {
            display: none;
        }

        [data-theme="light"] .theme-toggle .sun-icon {
            display: block;
        }

        /* Main Content */
        .main {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
        }

        /* Page Title */
        .page-title {
            margin-bottom: 24px;
        }

        .page-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .page-title p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Filters */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            padding: 10px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            min-width: 160px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-1);
        }

        .filter-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        /* KPI Cards */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .kpi-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .kpi-card:hover {
            transform: translateY(-4px);
            background: var(--bg-card-hover);
            border-color: var(--accent-1);
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--kpi-color, var(--gradient-1));
        }

        .kpi-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: var(--kpi-bg, var(--bg-tertiary));
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
        }

        .kpi-icon svg {
            width: 22px;
            height: 22px;
            color: var(--kpi-icon-color, var(--accent-1));
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 4px;
            background: var(--kpi-color, var(--gradient-1));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .kpi-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .kpi-trend {
            position: absolute;
            top: 24px;
            right: 24px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .kpi-trend.up {
            background: rgba(239, 68, 68, 0.1);
            color: var(--critical);
        }

        .kpi-trend.down {
            background: rgba(16, 185, 129, 0.1);
            color: var(--minor);
        }

        .kpi-trend svg {
            width: 14px;
            height: 14px;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        @media (max-width: 1024px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
        }

        .chart-card.full-width {
            grid-column: span 2;
        }

        @media (max-width: 1024px) {
            .chart-card.full-width {
                grid-column: span 1;
            }
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .chart-subtitle {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .chart-container {
            position: relative;
            height: 280px;
        }

        .chart-container.small {
            height: 220px;
        }

        /* Data Table */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .table-title {
            font-size: 1rem;
            font-weight: 600;
        }

        .search-box {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            min-width: 240px;
        }

        .search-box svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
        }

        .search-box input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 0.9rem;
            width: 100%;
        }

        .search-box input::placeholder {
            color: var(--text-muted);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 12px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .data-table th:hover {
            color: var(--text-primary);
        }

        .data-table td {
            font-size: 0.9rem;
        }

        .data-table tr:hover {
            background: var(--bg-card-hover);
        }

        .severity-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .severity-badge.critical {
            background: rgba(239, 68, 68, 0.15);
            color: var(--critical);
        }

        .severity-badge.major {
            background: rgba(245, 158, 11, 0.15);
            color: var(--major);
        }

        .severity-badge.minor {
            background: rgba(16, 185, 129, 0.15);
            color: var(--minor);
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-1);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .loading-overlay.hidden {
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-wrap: wrap;
            }

            .main {
                padding: 16px;
            }

            .page-title h1 {
                font-size: 1.4rem;
            }

            .kpi-grid {
                grid-template-columns: 1fr 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .filter-select {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .kpi-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Memuat data dari Google Sheets...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <a href="../index.html" class="back-btn">
                    <i data-lucide="arrow-left"></i>
                    <span>Kembali</span>
                </a>
                <div class="logo">
                    <div class="logo-icon">
                        <i data-lucide="activity"></i>
                    </div>
                    <span class="logo-text">SDWAN Dashboard</span>
                </div>
            </div>
            <div class="header-right">
                <div class="last-update">
                    <i data-lucide="clock"></i>
                    <span id="lastUpdate">-</span>
                </div>
                <button class="refresh-btn" onclick="refreshData()" title="Refresh Data">
                    <i data-lucide="refresh-cw"></i>
                </button>
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Theme">
                    <i data-lucide="moon" class="moon-icon"></i>
                    <i data-lucide="sun" class="sun-icon"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Page Title -->
        <div class="page-title">
            <h1>üìä Surveillance Monitoring Dashboard</h1>
            <p>Real-time monitoring data dari Logbook Surveillance SDWAN Center</p>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-group">
                <span class="filter-label">Periode</span>
                <select class="filter-select" id="filterMonth" onchange="applyFilters()">
                    <option value="all">Semua Bulan</option>
                </select>
            </div>
            <div class="filter-group">
                <span class="filter-label">Severity</span>
                <select class="filter-select" id="filterSeverity" onchange="applyFilters()">
                    <option value="all">Semua Severity</option>
                    <option value="critical">Critical</option>
                    <option value="major">Major</option>
                    <option value="minor">Minor</option>
                </select>
            </div>
        </div>

        <!-- KPI Cards -->
        <div class="kpi-grid" style="grid-template-columns: repeat(3, 1fr);">
            <div class="kpi-card" style="--kpi-color: var(--gradient-1); --kpi-icon-color: var(--accent-1);">
                <div class="kpi-icon">
                    <i data-lucide="bell-ring"></i>
                </div>
                <div class="kpi-value" id="kpiTotalAlerts">-</div>
                <div class="kpi-label">Total Alerts</div>
            </div>
            <!-- Ticket KPI Cards -->
            <div class="kpi-card"
                style="--kpi-color: linear-gradient(135deg, #3b82f6, #1d4ed8); --kpi-icon-color: #3b82f6;">
                <div class="kpi-icon">
                    <i data-lucide="ticket"></i>
                </div>
                <div class="kpi-value" id="kpiTotalTickets">-</div>
                <div class="kpi-label">Total Tickets</div>
            </div>
            <div class="kpi-card"
                style="--kpi-color: linear-gradient(135deg, #10b981, #059669); --kpi-icon-color: #10b981;">
                <div class="kpi-icon">
                    <i data-lucide="check-circle-2"></i>
                </div>
                <div class="kpi-value" id="kpiTicketsClosed">-</div>
                <div class="kpi-label">Tickets Closed</div>
            </div>
        </div>

        <!-- Charts -->
        <div class="charts-grid">
            <!-- Trend Chart -->
            <div class="chart-card full-width">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">üìà Trend Alerts Bulanan</h3>
                        <p class="chart-subtitle">Jumlah alert dari waktu ke waktu</p>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>

            <!-- Top Tenants Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">üè¢ Top 10 Tenants</h3>
                        <p class="chart-subtitle">Tenant dengan alert terbanyak</p>
                    </div>
                </div>
                <div class="chart-container small">
                    <canvas id="tenantsChart"></canvas>
                </div>
            </div>

            <!-- Ticket Status Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <div>
                        <h3 class="chart-title">üé´ Status Ticket</h3>
                        <p class="chart-subtitle">Distribusi status ticket</p>
                    </div>
                </div>
                <div class="chart-container small">
                    <canvas id="ticketStatusChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="table-card">
            <div class="table-header">
                <h3 class="table-title">üìã Detail Data per Tenant</h3>
                <div class="search-box">
                    <i data-lucide="search"></i>
                    <input type="text" id="searchInput" placeholder="Cari tenant..." oninput="filterTable()">
                </div>
            </div>
            <table class="data-table">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">No</th>
                        <th onclick="sortTable(1)">Tenant</th>
                        <th onclick="sortTable(2)">Total Alerts</th>
                        <th onclick="sortTable(3)">Total Tickets</th>
                        <th onclick="sortTable(4)">Open</th>
                        <th onclick="sortTable(5)">Closed</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--text-muted);">Memuat data...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </main>

    <script>
        // Configuration
        const SPREADSHEET_ID = '1fN9rjfshG7UxOOElU-o6Cyd7Ep_ztkUnR6TUbAZPVA8';
        const SHEET_NAME = 'Rekap Pivot';
        const API_KEY = 'AIzaSyCw05dTADgo4vrMZxrBBStuxljaV1Iwu5Q';

        // Global data store
        let dashboardData = {
            raw: [],
            filtered: [],
            months: [],
            tenants: [],
            ticketTotals: { open: 0, closed: 0 }
        };

        // Chart instances
        let trendChart, severityChart, tenantsChart, ticketStatusChart;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            initTheme();
            await fetchData();
        });

        // Fetch data from Google Sheets API v4
        async function fetchData() {
            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.remove('hidden');

            try {
                // Google Sheets API v4 endpoint
                const range = encodeURIComponent(`${SHEET_NAME}!A1:Z1000`);
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${range}?key=${API_KEY}`;

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const values = data.values || [];

                console.log('API v4 Response:', values.length, 'rows');

                // Parse data from API v4 format
                parseDataV4(values);
                updateDashboard();
                updateLastUpdate();

            } catch (error) {
                console.error('Error fetching data:', error);
                // Try JSONP fallback
                try {
                    await fetchDataJSONP();
                } catch (e) {
                    console.error('JSONP also failed:', e);
                    loadSampleData();
                }
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        // Parse data from Google Sheets API v4 format - Specific to Rekap Pivot structure
        function parseDataV4(values) {
            dashboardData.raw = [];
            dashboardData.months = [];

            console.log('Parsing V4 data (Rekap Pivot), rows:', values.length);

            // Valid months we want to include (Mei - Desember)
            const validMonths = ['mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];

            // Data structures for aggregated data
            const monthlyTotals = {};
            const severityTotals = { critical: 0, major: 0, minor: 0 };
            const tenantTotals = {};

            // Parse the sheet by scanning all rows
            for (let i = 0; i < values.length; i++) {
                const row = values[i];
                if (!row || row.length === 0) continue;

                // Check column B (index 1) for month names - Monthly trend data
                const colB = (row[1] || '').toString().trim();
                const colBLower = colB.toLowerCase();
                const colC = row[2] ? parseInt(row[2]) : 0;

                // Check if this is a month row (Mei, Juni, etc.)
                if (validMonths.some(m => colBLower.includes(m)) && colC > 0) {
                    const monthName = colB.trim();
                    monthlyTotals[monthName] = colC;
                    if (!dashboardData.months.includes(monthName)) {
                        dashboardData.months.push(monthName);
                    }
                    console.log('Found month:', monthName, '=', colC);
                }

                // Check for severity data (Critical/Major/Minor)
                if (colBLower.includes('critical') && colC > 0) {
                    severityTotals.critical = colC;
                    console.log('Found Critical:', colC);
                } else if (colBLower.includes('major') && colC > 0) {
                    severityTotals.major = colC;
                    console.log('Found Major:', colC);
                } else if (colBLower.includes('minor') && colC > 0) {
                    severityTotals.minor = colC;
                    console.log('Found Minor:', colC);
                }

                // Check for ticket status data - Only Open and Closed (from Column J)
                // Note: "Cleared" is Alert Status (Column H), not Ticket Status
                if (colBLower === 'open' && colC > 0) {
                    dashboardData.ticketTotals.open = colC;
                    console.log('Found Ticket Open:', colC);
                } else if (colBLower === 'closed' && colC > 0) {
                    dashboardData.ticketTotals.closed = colC;
                    console.log('Found Ticket Closed:', colC);
                }

                // Check column E (index 4) for tenant names - Tenant data
                const colE = (row[4] || '').toString().trim();
                const colF = row[5] ? parseInt(row[5]) : 0;

                if (colE && colF > 0 &&
                    !colE.toLowerCase().includes('row label') &&
                    !colE.toLowerCase().includes('tenant') &&
                    !colE.toLowerCase().includes('grand total')) {
                    tenantTotals[colE] = (tenantTotals[colE] || 0) + colF;
                    console.log('Found tenant:', colE, '=', colF);
                }
            }

            // Calculate total tickets
            dashboardData.ticketTotals.total = dashboardData.ticketTotals.cleared +
                dashboardData.ticketTotals.open +
                dashboardData.ticketTotals.closed;

            console.log('Months found:', dashboardData.months);
            console.log('Monthly totals:', monthlyTotals);
            console.log('Severity totals:', severityTotals);
            console.log('Tenant count:', Object.keys(tenantTotals).length);

            // Convert tenant totals to raw data format
            Object.entries(tenantTotals)
                .sort((a, b) => b[1] - a[1]) // Sort by total descending
                .forEach(([tenant, total]) => {
                    // Assign severity based on total
                    let severity = 'minor';
                    if (total > 500) severity = 'critical';
                    else if (total > 100) severity = 'major';

                    dashboardData.raw.push({
                        tenant: tenant,
                        severity: severity,
                        monthly: {}, // We don't have per-tenant monthly breakdown
                        total: total
                    });
                });

            // Store aggregated data for charts
            dashboardData.monthlyTotals = monthlyTotals;
            dashboardData.severityTotals = severityTotals;

            dashboardData.tenants = [...new Set(dashboardData.raw.map(r => r.tenant))];
            dashboardData.filtered = [...dashboardData.raw];

            console.log('Parsed rows:', dashboardData.raw.length);

            // Populate month filter
            const monthFilter = document.getElementById('filterMonth');
            monthFilter.innerHTML = '<option value="all">Semua Bulan</option>';
            dashboardData.months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });
        }

        // JSONP Fallback
        async function fetchDataJSONP() {
            const callbackName = 'googleSheetsCallback_' + Date.now();
            const url = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json;responseHandler:${callbackName}&sheet=${encodeURIComponent(SHEET_NAME)}`;

            const dataPromise = new Promise((resolve, reject) => {
                const timeout = setTimeout(() => {
                    delete window[callbackName];
                    reject(new Error('Request timeout'));
                }, 15000);

                window[callbackName] = function (response) {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    resolve(response);
                };
            });

            const script = document.createElement('script');
            script.src = url;
            script.onerror = () => {
                delete window[callbackName];
                throw new Error('Failed to load script');
            };
            document.head.appendChild(script);

            const json = await dataPromise;
            script.remove();

            const rows = json.table.rows;
            const cols = json.table.cols;

            parseData(rows, cols);
            updateDashboard();
            updateLastUpdate();
        }

        // Sample data for demo/fallback
        function loadSampleData() {
            console.log('Loading sample data...');

            // Sample data based on spreadsheet structure
            dashboardData.months = ['Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober'];
            dashboardData.raw = [
                { tenant: 'KIMIA FARMA APOTEK', severity: 'critical', monthly: { 'Maret': 245, 'April': 312, 'Mei': 287, 'Juni': 198, 'Juli': 256, 'Agustus': 223, 'September': 201, 'Oktober': 189 }, total: 1911 },
                { tenant: 'BPJSTK', severity: 'critical', monthly: { 'Maret': 189, 'April': 234, 'Mei': 198, 'Juni': 167, 'Juli': 201, 'Agustus': 178, 'September': 156, 'Oktober': 143 }, total: 1466 },
                { tenant: 'MANDIRI', severity: 'critical', monthly: { 'Maret': 156, 'April': 189, 'Mei': 167, 'Juni': 134, 'Juli': 178, 'Agustus': 145, 'September': 123, 'Oktober': 112 }, total: 1204 },
                { tenant: 'POLDA KALTARA', severity: 'major', monthly: { 'Maret': 98, 'April': 112, 'Mei': 87, 'Juni': 76, 'Juli': 95, 'Agustus': 82, 'September': 71, 'Oktober': 65 }, total: 686 },
                { tenant: 'ADARO INDONESIA', severity: 'major', monthly: { 'Maret': 87, 'April': 95, 'Mei': 78, 'Juni': 65, 'Juli': 82, 'Agustus': 71, 'September': 59, 'Oktober': 52 }, total: 589 },
                { tenant: 'ADARO LOGISTICS', severity: 'major', monthly: { 'Maret': 76, 'April': 82, 'Mei': 69, 'Juni': 54, 'Juli': 71, 'Agustus': 62, 'September': 48, 'Oktober': 43 }, total: 505 },
                { tenant: 'TELKOM REGIONAL', severity: 'minor', monthly: { 'Maret': 54, 'April': 67, 'Mei': 48, 'Juni': 43, 'Juli': 56, 'Agustus': 49, 'September': 38, 'Oktober': 34 }, total: 389 },
                { tenant: 'PERTAMINA', severity: 'minor', monthly: { 'Maret': 45, 'April': 52, 'Mei': 39, 'Juni': 34, 'Juli': 47, 'Agustus': 41, 'September': 32, 'Oktober': 28 }, total: 318 },
                { tenant: 'PLN DISTRIBUSI', severity: 'minor', monthly: { 'Maret': 38, 'April': 45, 'Mei': 32, 'Juni': 27, 'Juli': 39, 'Agustus': 34, 'September': 26, 'Oktober': 23 }, total: 264 },
                { tenant: 'BANK BRI', severity: 'minor', monthly: { 'Maret': 32, 'April': 38, 'Mei': 27, 'Juni': 22, 'Juli': 34, 'Agustus': 29, 'September': 21, 'Oktober': 18 }, total: 221 }
            ];

            dashboardData.filtered = [...dashboardData.raw];
            dashboardData.tenants = dashboardData.raw.map(r => r.tenant);

            // Populate month filter
            const monthFilter = document.getElementById('filterMonth');
            monthFilter.innerHTML = '<option value="all">Semua Bulan</option>';
            dashboardData.months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });

            updateDashboard();
            updateLastUpdate();
        }

        // Parse spreadsheet data - handles Rekap Pivot structure
        function parseData(rows, cols) {
            dashboardData.raw = [];
            dashboardData.months = [];

            console.log('Parsing data, rows:', rows.length);

            // The Rekap Pivot has structure like:
            // Row 0: Empty or title
            // Row 1: Headers (Row Labels, Severity, Month names...)
            // Row 2+: Data rows (Tenant, Severity, Monthly values...)

            // Try to find header row by looking for month names or "Row Labels"
            let headerRowIndex = -1;
            let severityColIndex = -1;
            let monthStartIndex = -1;

            for (let i = 0; i < Math.min(rows.length, 15); i++) {
                const row = rows[i];
                if (!row || !row.c) continue;

                for (let j = 0; j < row.c.length; j++) {
                    const cellValue = row.c[j]?.v?.toString() || '';
                    const cellLower = cellValue.toLowerCase();

                    // Look for common month names or header indicators
                    if (cellLower.includes('maret') || cellLower.includes('april') ||
                        cellLower.includes('januari') || cellLower.includes('februari') ||
                        cellLower === 'mar' || cellLower === 'apr') {
                        headerRowIndex = i;
                        monthStartIndex = j;
                        break;
                    }
                    if (cellLower === 'severity' || cellLower.includes('severity')) {
                        severityColIndex = j;
                    }
                }
                if (headerRowIndex >= 0) break;
            }

            // If no header found, try alternative detection
            if (headerRowIndex < 0) {
                for (let i = 0; i < Math.min(rows.length, 10); i++) {
                    const row = rows[i];
                    if (!row || !row.c) continue;

                    const firstCell = row.c[0]?.v?.toString().toLowerCase() || '';
                    if (firstCell.includes('row label') || firstCell.includes('tenant') ||
                        firstCell.includes('nama') || firstCell === 'no') {
                        headerRowIndex = i;
                        monthStartIndex = severityColIndex > 0 ? severityColIndex + 1 : 2;
                        break;
                    }
                }
            }

            // Default if still not found
            if (headerRowIndex < 0) {
                console.log('No header found, using defaults');
                headerRowIndex = 0;
                monthStartIndex = 2;
            }

            const headerRow = rows[headerRowIndex];
            console.log('Header row index:', headerRowIndex, 'Month start:', monthStartIndex);

            // Extract month names from header - Filter only Mei to Desember
            const validMonths = ['mei', 'juni', 'juli', 'agustus', 'september', 'oktober', 'november', 'desember'];
            if (headerRow && headerRow.c) {
                for (let i = monthStartIndex; i < headerRow.c.length; i++) {
                    const cellValue = headerRow.c[i]?.v?.toString() || '';
                    const cellLower = cellValue.toLowerCase();
                    // Only include months from Mei to Desember
                    if (cellValue && !cellLower.includes('grand') &&
                        !cellLower.includes('total') &&
                        (validMonths.some(m => cellLower.includes(m)) || dashboardData.months.length > 0)) {
                        // Check if this is a valid month we want
                        if (validMonths.some(m => cellLower.includes(m))) {
                            dashboardData.months.push(cellValue);
                        }
                    }
                }
            }
            console.log('Months found:', dashboardData.months);

            // Parse data rows
            for (let i = headerRowIndex + 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row.c) continue;

                const firstCell = row.c[0]?.v?.toString() || '';
                if (!firstCell || firstCell.toLowerCase().includes('grand total') ||
                    firstCell.toLowerCase().includes('(blank)')) continue;

                const rowData = {
                    tenant: firstCell,
                    severity: '',
                    monthly: {},
                    total: 0
                };

                // Get severity if column exists
                if (severityColIndex > 0 && row.c[severityColIndex]) {
                    const sev = row.c[severityColIndex]?.v?.toString().toLowerCase() || '';
                    if (sev.includes('critical')) rowData.severity = 'critical';
                    else if (sev.includes('major')) rowData.severity = 'major';
                    else if (sev.includes('minor')) rowData.severity = 'minor';
                }

                // Parse monthly values
                for (let j = 0; j < dashboardData.months.length; j++) {
                    const colIndex = monthStartIndex + j;
                    const value = parseInt(row.c[colIndex]?.v) || 0;
                    const monthName = dashboardData.months[j];
                    if (monthName) {
                        rowData.monthly[monthName] = value;
                        rowData.total += value;
                    }
                }

                if (rowData.total > 0) {
                    dashboardData.raw.push(rowData);
                }
            }

            console.log('Parsed rows:', dashboardData.raw.length);

            // Assign severity based on position if not detected
            if (dashboardData.raw.length > 0 && !dashboardData.raw.some(r => r.severity)) {
                const third = Math.ceil(dashboardData.raw.length / 3);
                dashboardData.raw.forEach((row, index) => {
                    if (index < third) row.severity = 'critical';
                    else if (index < third * 2) row.severity = 'major';
                    else row.severity = 'minor';
                });
            }

            // Get unique tenants
            dashboardData.tenants = [...new Set(dashboardData.raw.map(r => r.tenant))];
            dashboardData.filtered = [...dashboardData.raw];

            // Populate month filter
            const monthFilter = document.getElementById('filterMonth');
            monthFilter.innerHTML = '<option value="all">Semua Bulan</option>';
            dashboardData.months.forEach(month => {
                const option = document.createElement('option');
                option.value = month;
                option.textContent = month;
                monthFilter.appendChild(option);
            });
        }

        // Update dashboard with current data
        function updateDashboard() {
            updateKPIs();
            updateCharts();
            updateTable();
        }

        // Update KPI cards - Only Total Alerts and Ticket KPIs
        function updateKPIs() {
            const data = dashboardData.filtered;

            let totalAlerts = 0;

            // Calculate total alerts from severity totals if available
            if (dashboardData.severityTotals &&
                (dashboardData.severityTotals.critical > 0 ||
                    dashboardData.severityTotals.major > 0 ||
                    dashboardData.severityTotals.minor > 0)) {
                totalAlerts = dashboardData.severityTotals.critical +
                    dashboardData.severityTotals.major +
                    dashboardData.severityTotals.minor;
            } else {
                // Fallback to calculating from raw data
                data.forEach(row => {
                    totalAlerts += row.total;
                });
            }

            document.getElementById('kpiTotalAlerts').textContent = totalAlerts.toLocaleString();

            // Update ticket KPIs (Total = Open + Closed)
            const ticketData = dashboardData.ticketTotals;
            const totalTickets = ticketData.open + ticketData.closed;
            document.getElementById('kpiTotalTickets').textContent = totalTickets.toLocaleString();
            document.getElementById('kpiTicketsClosed').textContent = ticketData.closed.toLocaleString();
        }

        // Update charts - Severity chart removed
        function updateCharts() {
            updateTrendChart();
            updateTenantsChart();
            updateTicketStatusChart();
        }

        // Trend Chart
        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');

            // Use aggregated monthly totals if available (from API v4)
            let monthlyTotals = {};

            if (dashboardData.monthlyTotals && Object.keys(dashboardData.monthlyTotals).length > 0) {
                monthlyTotals = dashboardData.monthlyTotals;
            } else {
                // Fallback to calculating from raw data
                dashboardData.months.forEach(month => {
                    monthlyTotals[month] = 0;
                });

                dashboardData.filtered.forEach(row => {
                    Object.keys(row.monthly).forEach(month => {
                        if (monthlyTotals[month] !== undefined) {
                            monthlyTotals[month] += row.monthly[month];
                        }
                    });
                });
            }

            const labels = dashboardData.months.length > 0 ? dashboardData.months : Object.keys(monthlyTotals);
            const data = labels.map(m => monthlyTotals[m] || 0);

            if (trendChart) trendChart.destroy();

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Alerts',
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#6366f1',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#a0a0b0'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#a0a0b0'
                            }
                        }
                    }
                }
            });
        }

        // Severity Chart
        function updateSeverityChart() {
            const ctx = document.getElementById('severityChart').getContext('2d');

            let critical = 0, major = 0, minor = 0;

            dashboardData.filtered.forEach(row => {
                if (row.severity === 'critical') critical += row.total;
                else if (row.severity === 'major') major += row.total;
                else if (row.severity === 'minor') minor += row.total;
            });

            // Estimate if no severity data
            const total = dashboardData.filtered.reduce((sum, row) => sum + row.total, 0);
            if (critical === 0 && major === 0 && minor === 0 && total > 0) {
                critical = Math.round(total * 0.6);
                major = Math.round(total * 0.3);
                minor = total - critical - major;
            }

            if (severityChart) severityChart.destroy();

            severityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Critical', 'Major', 'Minor'],
                    datasets: [{
                        data: [critical, major, minor],
                        backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#a0a0b0',
                                padding: 16
                            }
                        }
                    },
                    cutout: '60%'
                }
            });
        }

        // Top Tenants Chart
        function updateTenantsChart() {
            const ctx = document.getElementById('tenantsChart').getContext('2d');

            // Aggregate by tenant
            const tenantTotals = {};
            dashboardData.filtered.forEach(row => {
                if (!tenantTotals[row.tenant]) {
                    tenantTotals[row.tenant] = 0;
                }
                tenantTotals[row.tenant] += row.total;
            });

            // Sort and get top 10
            const sorted = Object.entries(tenantTotals)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            const labels = sorted.map(([name]) => name.length > 20 ? name.substring(0, 20) + '...' : name);
            const data = sorted.map(([, value]) => value);

            if (tenantsChart) tenantsChart.destroy();

            tenantsChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Alerts',
                        data: data,
                        backgroundColor: 'rgba(139, 92, 246, 0.8)',
                        borderColor: '#8b5cf6',
                        borderWidth: 1,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#a0a0b0'
                            }
                        },
                        y: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#a0a0b0',
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Ticket Status Chart
        function updateTicketStatusChart() {
            const ctx = document.getElementById('ticketStatusChart').getContext('2d');

            const ticketData = dashboardData.ticketTotals;

            if (ticketStatusChart) ticketStatusChart.destroy();

            ticketStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Open', 'Closed'],
                    datasets: [{
                        data: [ticketData.open, ticketData.closed],
                        backgroundColor: [
                            'rgba(245, 158, 11, 0.8)', // Orange for Open
                            'rgba(16, 185, 129, 0.8)'  // Green for Closed
                        ],
                        borderColor: [
                            '#f59e0b',
                            '#10b981'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#a0a0b0',
                                padding: 15,
                                usePointStyle: true
                            }
                        }
                    }
                }
            });
        }

        // Update data table - Now shows Ticket data instead of Severity
        function updateTable() {
            const tbody = document.getElementById('tableBody');

            // Aggregate by tenant - for now using sample data format
            // Each tenant will show: Total Alerts, Total Tickets, Open, Closed
            const tenantData = {};
            dashboardData.filtered.forEach(row => {
                if (!tenantData[row.tenant]) {
                    tenantData[row.tenant] = {
                        totalAlerts: 0,
                        totalTickets: 0,
                        open: 0,
                        closed: 0
                    };
                }
                tenantData[row.tenant].totalAlerts += row.total;
                // Ticket data per tenant (sample - can be updated when real data available)
                tenantData[row.tenant].totalTickets = row.tickets || 0;
                tenantData[row.tenant].open = row.ticketsOpen || 0;
                tenantData[row.tenant].closed = row.ticketsClosed || 0;
            });

            // Sort by total alerts
            const sorted = Object.entries(tenantData).sort((a, b) => b[1].totalAlerts - a[1].totalAlerts);

            tbody.innerHTML = sorted.map(([tenant, data], index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${tenant}</td>
                    <td><strong>${data.totalAlerts.toLocaleString()}</strong></td>
                    <td><span class="severity-badge" style="background: rgba(59, 130, 246, 0.2); color: #3b82f6;">${data.totalTickets.toLocaleString()}</span></td>
                    <td><span class="severity-badge major">${data.open.toLocaleString()}</span></td>
                    <td><span class="severity-badge minor">${data.closed.toLocaleString()}</span></td>
                </tr>
            `).join('');

            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted);">Tidak ada data</td></tr>';
            }
        }

        // Apply filters
        function applyFilters() {
            const monthFilter = document.getElementById('filterMonth').value;
            const severityFilter = document.getElementById('filterSeverity').value;

            dashboardData.filtered = dashboardData.raw.filter(row => {
                // Severity filter
                if (severityFilter !== 'all' && row.severity !== severityFilter) {
                    return false;
                }
                return true;
            });

            // If month filter is applied, recalculate totals
            if (monthFilter !== 'all') {
                dashboardData.filtered = dashboardData.filtered.map(row => ({
                    ...row,
                    total: row.monthly[monthFilter] || 0
                })).filter(row => row.total > 0);
            }

            updateDashboard();
        }

        // Filter table by search
        function filterTable() {
            const searchValue = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#tableBody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchValue) ? '' : 'none';
            });
        }

        // Sort table
        let sortDirection = 1;
        function sortTable(columnIndex) {
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                const aVal = a.cells[columnIndex]?.textContent || '';
                const bVal = b.cells[columnIndex]?.textContent || '';

                if (!isNaN(aVal.replace(/,/g, '')) && !isNaN(bVal.replace(/,/g, ''))) {
                    return (parseInt(aVal.replace(/,/g, '')) - parseInt(bVal.replace(/,/g, ''))) * sortDirection;
                }
                return aVal.localeCompare(bVal) * sortDirection;
            });

            sortDirection *= -1;
            rows.forEach(row => tbody.appendChild(row));
        }

        // Refresh data
        async function refreshData() {
            const btn = document.querySelector('.refresh-btn');
            btn.classList.add('loading');
            await fetchData();
            btn.classList.remove('loading');
        }

        // Update last update time
        function updateLastUpdate() {
            const now = new Date();
            const options = { hour: '2-digit', minute: '2-digit', day: '2-digit', month: 'short' };
            document.getElementById('lastUpdate').textContent = now.toLocaleDateString('id-ID', options);
        }

        // Theme toggle
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Recreate icons
            lucide.createIcons();
        }

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // Auto refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
    </script>
</body>

</html>